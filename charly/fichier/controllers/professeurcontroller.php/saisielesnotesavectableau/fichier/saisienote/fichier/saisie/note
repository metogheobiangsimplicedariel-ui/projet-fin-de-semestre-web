<?php
$matiereId = $_GET['matiere_id'] ?? 0;
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie des Notes - Professeur</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --couleur-sauvegarde: #d4edda;
            --couleur-modification: #fff3cd;
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
        }
        
        .note-input {
            width: 80px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            padding: 5px;
        }
        
        .note-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: scale(1.05);
        }
        
        .note-input.saved {
            background-color: var(--couleur-sauvegarde);
            border-color: #28a745;
        }
        
        .note-input.modified {
            background-color: var(--couleur-modification);
            border-color: #ffc107;
        }
        
        .moyenne-cell {
            background-color: #e9ecef;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .header-colonne {
            min-width: 120px;
            background-color: #f1f3f4;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .etudiant-cell {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 5;
            min-width: 200px;
            border-right: 2px solid #dee2e6;
        }
        
        .table-scroll {
            overflow-x: auto;
            max-height: 70vh;
        }
        
        .badge-coeff {
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .statut-sauvegarde {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/professeur/mes_matieres.php">
                <i class="bi bi-arrow-left"></i> Retour aux matières
            </a>
            <div class="navbar-text text-white">
                <span id="compteur-sauvegardes">0 note(s) sauvegardée(s)</span>
            </div>
        </div>
    </nav>
    
    <!-- Statut de sauvegarde -->
    <div id="statut-sauvegarde" class="statut-sauvegarde alert alert-success">
        <i class="bi bi-check-circle"></i> <span id="message-sauvegarde"></span>
    </div>
    
    <div class="container-fluid mt-3">
        <!-- En-tête -->
        <div class="table-header mb-3">
            <h2><i class="bi bi-pencil-square"></i> Saisie des Notes</h2>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-light text-dark">Matière: <?= htmlspecialchars($matiereId) ?></span>
                    <span class="badge bg-info ms-2"><?= count($etudiants) ?> étudiant(s)</span>
                    <span class="badge bg-warning ms-2"><?= count($colonnes) ?> colonne(s)</span>
                </div>
                <div>
                    <button id="btn-sauvegarder-tout" class="btn btn-success">
                        <i class="bi bi-save"></i> Sauvegarder toutes les modifications
                    </button>
                    <button id="btn-reinitialiser" class="btn btn-outline-light ms-2">
                        <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tableau des notes -->
        <div class="table-container">
            <div class="table-scroll">
                <table class="table table-bordered table-hover mb-0" id="tableau-notes">
                    <thead class="table-light">
                        <tr>
                            <th class="etudiant-cell">Étudiants</th>
                            <?php foreach ($colonnes as $colonne): ?>
                            <th class="header-colonne text-center">
                                <div class="d-flex flex-column">
                                    <span><?= htmlspecialchars($colonne['nom_colonne']) ?></span>
                                    <small class="text-muted">
                                        Coeff: <span class="badge bg-secondary badge-coeff"><?= $colonne['coefficient'] ?></span>
                                    </small>
                                </div>
                            </th>
                            <?php endforeach; ?>
                            <th class="header-colonne text-center moyenne-cell">MOYENNE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php 
                        $indexEtudiant = 0;
                        foreach ($etudiants as $etudiant): 
                            $indexEtudiant++;
                        ?>
                        <tr data-etudiant-id="<?= $etudiant['id'] ?>">
                            <!-- Cellule étudiant -->
                            <td class="etudiant-cell">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <span class="badge bg-dark rounded-circle"><?= $indexEtudiant ?></span>
                                    </div>
                                    <div>
                                        <strong><?= htmlspecialchars($etudiant['nom'] . ' ' . $etudiant['prenom']) ?></strong><br>
                                        <small class="text-muted"><?= htmlspecialchars($etudiant['numero_etudiant'] ?? 'N/A') ?></small>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Inputs pour chaque colonne -->
                            <?php 
                            $sommeNotes = 0;
                            $sommeCoeffs = 0;
                            
                            foreach ($colonnes as $colonne): 
                                $noteValue = '';
                                $noteData = null;
                                
                                if (isset($notesExistantes[$etudiant['id']][$colonne['id']])) {
                                    $noteData = $notesExistantes[$etudiant['id']][$colonne['id']];
                                    $noteValue = $noteData['valeur'];
                                    
                                    if (is_numeric($noteValue)) {
                                        $sommeNotes += $noteValue * $colonne['coefficient'];
                                        $sommeCoeffs += $colonne['coefficient'];
                                    }
                                }
                            ?>
                            <td class="text-center align-middle">
                                <input type="number"
                                       class="form-control note-input mx-auto"
                                       min="0"
                                       max="20"
                                       step="0.01"
                                       placeholder="0-20"
                                       data-etudiant-id="<?= $etudiant['id'] ?>"
                                       data-colonne-id="<?= $colonne['id'] ?>"
                                       data-coefficient="<?= $colonne['coefficient'] ?>"
                                       value="<?= $noteValue ?>"
                                       data-original-value="<?= $noteValue ?>"
                                       oninput="gererModification(this)">
                                       
                                <?php if ($noteData && $noteData['date_saisie']): ?>
                                <div class="mt-1">
                                    <small class="text-muted" title="<?= htmlspecialchars($noteData['date_saisie']) ?>">
                                        <i class="bi bi-clock"></i> <?= date('d/m', strtotime($noteData['date_saisie'])) ?>
                                    </small>
                                </div>
                                <?php endif; ?>
                            </td>
                            <?php endforeach; ?>
                            
                            <!-- Cellule moyenne -->
                            <td class="text-center align-middle moyenne-cell">
                                <span id="moyenne-<?= $etudiant['id'] ?>" class="moyenne-value">
                                    <?php
                                    if ($sommeCoeffs > 0) {
                                        $moyenne = $sommeNotes / $sommeCoeffs;
                                        echo number_format($moyenne, 2, ',', ' ');
                                    } else {
                                        echo '-';
                                    }
                                    ?>
                                </span>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="bi bi-calculator"></i> Coeff: <?= $sommeCoeffs ?>
                                    </small>
                                </div>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Panneau d'informations -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Instructions de saisie</h5>
                    <ul class="mb-0">
                        <li>Entrez les notes entre <strong>0 et 20</strong></li>
                        <li>Utilisez le point pour les décimales (ex: 15.5)</li>
                        <li>La sauvegarde est automatique quand vous quittez un champ</li>
                        <li>Les notes en <span class="text-success">vert</span> sont sauvegardées</li>
                        <li>Les notes en <span class="text-warning">jaune</span> sont modifiées mais non sauvegardées</li>
                        <li>La moyenne est calculée automatiquement</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-graph-up"></i> Statistiques rapides</h5>
                        <div id="statistiques-rapides">
                            <p class="card-text">
                                <span class="badge bg-primary" id="count-notes">Chargement...</span> notes saisies<br>
                                <span class="badge bg-success" id="count-sauvegardees">0</span> sauvegardées<br>
                                <span class="badge bg-warning" id="count-modifiees">0</span> modifiées
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmation -->
    <div class="modal fade" id="modal-confirmation" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-question-circle"></i> Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="message-confirmation"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="btn-confirmer">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let modificationsEnCours = {};
        let compteurSauvegardes = 0;
        let compteurModifications = 0;
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initialiserTableau();
            calculerStatistiques();
            mettreAJourCompteurs();
        });
        
        function initialiserTableau() {
            const inputs = document.querySelectorAll('.note-input');
            inputs.forEach(input => {
                // Stocker la valeur originale
                input.dataset.originalValue = input.value;
                
                // Gérer le focus
                input.addEventListener('focus', function() {
                    this.select();
                });
                
                // Gérer la perte de focus (sauvegarde auto)
                input.addEventListener('blur', function() {
                    if (this.value !== this.dataset.originalValue) {
                        sauvegarderNote(this);
                    }
                });
                
                // Gérer la touche Entrée
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sauvegarderNote(this);
                        
                        // Passer au champ suivant
                        const inputs = Array.from(document.querySelectorAll('.note-input'));
                        const currentIndex = inputs.indexOf(this);
                        if (currentIndex < inputs.length - 1) {
                            inputs[currentIndex + 1].focus();
                        }
                    }
                });
            });
        }
        
        function gererModification(input) {
            // Validation basique
            const valeur = parseFloat(input.value);
            if (input.value !== '' && (isNaN(valeur) || valeur < 0 || valeur > 20)) {
                input.classList.add('is-invalid');
                return;
            }
            
            input.classList.remove('is-invalid');
            
            // Marquer comme modifié
            if (input.value !== input.dataset.originalValue) {
                input.classList.add('modified');
                input.classList.remove('saved');
                
                const key = input.dataset.etudiantId + '-' + input.dataset.colonneId;
                modificationsEnCours[key] = input;
            } else {
                input.classList.remove('modified');
                const key = input.dataset.etudiantId + '-' + input.dataset.colonneId;
                delete modificationsEnCours[key];
            }
            
            // Recalculer la moyenne
            calculerMoyenneEtudiant(input.dataset.etudiantId);
            calculerStatistiques();
            mettreAJourCompteurs();
        }
        
        function calculerMoyenneEtudiant(etudiantId) {
            const ligne = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
            const inputs = ligne.querySelectorAll('.note-input');
            
            let sommeNotes = 0;
            let sommeCoeffs = 0;
            
            inputs.forEach(input => {
                const valeur = parseFloat(input.value);
                const coefficient = parseFloat(input.dataset.coefficient);
                
                if (!isNaN(valeur)) {
                    sommeNotes += valeur * coefficient;
                    sommeCoeffs += coefficient;
                }
            });
            
            const celluleMoyenne = document.getElementById(`moyenne-${etudiantId}`);
            if (sommeCoeffs > 0) {
                const moyenne = sommeNotes / sommeCoeffs;
                celluleMoyenne.textContent = moyenne.toFixed(2).replace('.', ',');
                celluleMoyenne.className = 'moyenne-value';
                
                // Colorer selon la moyenne
                if (moyenne < 10) {
                    celluleMoyenne.classList.add('text-danger');
                } else if (moyenne < 12) {
                    celluleMoyenne.classList.add('text-warning');
                } else {
                    celluleMoyenne.classList.add('text-success');
                }
            } else {
                celluleMoyenne.textContent = '-';
                celluleMoyenne.className = 'moyenne-value';
            }
        }
        
        function sauvegarderNote(input) {
            const etudiantId = input.dataset.etudiantId;
            const colonneId = input.dataset.colonneId;
            const valeur = input.value.trim();
            
            // Validation
            if (valeur !== '') {
                const valNum = parseFloat(valeur);
                if (isNaN(valNum) || valNum < 0 || valNum > 20) {
                    afficherMessage('La note doit être entre 0 et 20', 'danger');
                    return false;
                }
                
                // Formatage
                input.value = valNum.toFixed(2);
            }
            
            // Préparation des données
            const data = {
                etudiant_id: etudiantId,
                colonne_id: colonneId,
                valeur: valeur !== '' ? parseFloat(valeur) : null,
                matiere_id: <?= $matiereId ?>
            };
            
            // Appel AJAX
            fetch('/api/sauvegarder_note.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Mise à jour visuelle
                    input.classList.remove('modified');
                    input.classList.add('saved');
                    input.dataset.originalValue = input.value;
                    
                    // Retirer des modifications en cours
                    const key = etudiantId + '-' + colonneId;
                    delete modificationsEnCours[key];
                    
                    // Mettre à jour les compteurs
                    compteurSauvegardes++;
                    calculerStatistiques();
                    mettreAJourCompteurs();
                    
                    // Message de succès
                    afficherMessage('Note sauvegardée avec succès', 'success');
                    
                    // Recalculer moyenne
                    calculerMoyenneEtudiant(etudiantId);
                    
                    // Retirer la classe saved après 2 secondes
                    setTimeout(() => {
                        input.classList.remove('saved');
                    }, 2000);
                } else {
                    afficherMessage('Erreur: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                afficherMessage('Erreur de connexion', 'danger');
            });
            
            return true;
        }
        
        function sauvegarderToutesLesNotes() {
            const keys = Object.keys(modificationsEnCours);
            if (keys.length === 0) {
                afficherMessage('Aucune modification à sauvegarder', 'info');
                return;
            }
            
            afficherConfirmation(
                `Voulez-vous sauvegarder ${keys.length} note(s) modifiée(s) ?`,
                function() {
                    let sauvegardesReussies = 0;
                    let total = keys.length;
                    
                    keys.forEach((key, index) => {
                        const input = modificationsEnCours[key];
                        if (sauvegarderNote(input)) {
                            sauvegardesReussies++;
                        }
                        
                        // Petit délai entre chaque sauvegarde
                        setTimeout(() => {
                            if (index === keys.length - 1) {
                                afficherMessage(
                                    `${sauvegardesReussies}/${total} notes sauvegardées`,
                                    'success'
                                );
                            }
                        }, index * 100);
                    });
                }
            );
        }
        
        function calculerStatistiques() {
            const inputs = document.querySelectorAll('.note-input');
            let notesSaisies = 0;
            let notesNonSaisies = 0;
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    notesSaisies++;
                } else {
                    notesNonSaisies++;
                }
            });
            
            document.getElementById('count-notes').textContent = notesSaisies + ' notes';
            document.getElementById('count-modifiees').textContent = Object.keys(modificationsEnCours).length + ' modifiées';
        }
        
        function mettreAJourCompteurs() {
            document.getElementById('compteur-sauvegardes').textContent = 
                compteurSauvegardes + ' note(s) sauvegardée(s)';
        }
        
        function afficherMessage(message, type) {
            const statut = document.getElementById('statut-sauvegarde');
            const messageSpan = document.getElementById('message-sauvegarde');
            
            statut.className = `statut-sauvegarde alert alert-${type}`;
            messageSpan.textContent = message;
            statut.style.display = 'block';
            
            setTimeout(() => {
                statut.style.display = 'none';
            }, 3000);
        }
        
        function afficherConfirmation(message, callback) {
            document.getElementById('message-confirmation').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('modal-confirmation'));
            
            document.getElementById('btn-confirmer').onclick = function() {
                modal.hide();
                callback();
            };
            
            modal.show();
        }
        
        // Gestion des boutons
        document.getElementById('btn-sauvegarder-tout').addEventListener('click', sauvegarderToutesLesNotes);
        
        document.getElementById('btn-reinitialiser').addEventListener('click', function() {
            afficherConfirmation('Réinitialiser toutes les modifications non sauvegardées ?', function() {
                const inputs = document.querySelectorAll('.note-input.modified');
                inputs.forEach(input => {
                    input.value = input.dataset.originalValue;
                    input.classList.remove('modified');
                    calculerMoyenneEtudiant(input.dataset.etudiantId);
                });
                modificationsEnCours = {};
                calculerStatistiques();
                afficherMessage('Modifications réinitialisées', 'info');
            });
        });
        
        // Export des fonctions pour débogage
        window.sauvegarderNote = sauvegarderNote;
        window.sauvegarderToutesLesNotes = sauvegarderToutesLesNotes;
    </script>
</body>
</html>