<?php
header('Content-Type: application/json');
session_start();

class ValidateurNote {
    private $noteMin = 0;
    private $noteMax = 20;
    private $decimalesMax = 2;
    
    public function valider($valeur) {
        $resultat = [
            'valide' => true,
            'message' => '',
            'valeur' => $valeur
        ];
        
        // Cas vide
        if ($valeur === null || $valeur === '') {
            return $resultat;
        }
        
        // Vérifier que c'est un nombre
        if (!is_numeric($valeur)) {
            $resultat['valide'] = false;
            $resultat['message'] = 'La valeur doit être numérique';
            return $resultat;
        }
        
        $nombre = floatval($valeur);
        
        // Vérifier la plage
        if ($nombre < $this->noteMin || $nombre > $this->noteMax) {
            $resultat['valide'] = false;
            $resultat['message'] = "La note doit être entre {$this->noteMin} et {$this->noteMax}";
            return $resultat;
        }
        
        // Vérifier les décimales
        $parties = explode('.', (string)$valeur);
        if (count($parties) > 1 && strlen($parties[1]) > $this->decimalesMax) {
            $resultat['valide'] = false;
            $resultat['message'] = "Maximum {$this->decimalesMax} décimales autorisées";
            return $resultat;
        }
        
        // Formater la valeur
        $resultat['valeur'] = round($nombre, $this->decimalesMax);
        
        return $resultat;
    }
    
    public function validerLot($notes) {
        $resultats = [];
        $toutesValides = true;
        
        foreach ($notes as $index => $note) {
            $validation = $this->valider($note['valeur']);
            $resultats[$index] = $validation;
            
            if (!$validation['valide']) {
                $toutesValides = false;
            }
        }
        
        return [
            'toutesValides' => $toutesValides,
            'resultats' => $resultats
        ];
    }
}

// Utilisation
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $json = file_get_contents('php://input');
    $data = json_decode($json, true);
    
    $validateur = new ValidateurNote();
    
    if (isset($data['note'])) {
        // Validation unique
        $resultat = $validateur->valider($data['note']);
        echo json_encode($resultat);
    } elseif (isset($data['notes'])) {
        // Validation par lot
        $resultat = $validateur->validerLot($data['notes']);
        echo json_encode($resultat);
    } else {
        echo json_encode([
            'valide' => false,
            'message' => 'Aucune donnée à valider'
        ]);
    }
}
?>